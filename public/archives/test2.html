<!DOCTYPE html>
        <html>
            <head>
                <meta charset="utf-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
                <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
                <title>test2</title>
                <link rel="stylesheet" href="../lib/semantic/dist/semantic.min.css">
                <link rel="stylesheet" href="../lib/highlight-github.css">
                <style>
                    #toc_container {
                        position: absolute;
                        top: 10px;
                        width: 250px;
                        right: 10px;
                        word-break: break-word;
                    }
                </style>
            </head>
            <body class="ui main text container">
                <a href="https://maicss.com/archives/test2.html#disqus_thread">count</a>
                <h1 id="-nginx-">本博客 Nginx 配置之完整篇</h1><p>最近有很多朋友邮件或者留言询问本博客服务端配置相关问题，基本都是关于 HTTPS 和 HTTP/2 的，其实我的 Nginx 配置在之前的文章中多次提到过，不过都比较分散。为了方便大家参考，本文贴出完整配置。</p>
<blockquote>
<p>本文内容会随时调整和更新，请不要把本文内容全文转载到第三方平台，以免给他人造成困扰或误导。另外限于篇幅，本文不对配置做过多说明，如有疑问或不同意见，欢迎留言讨论。</p>
</blockquote>
<h3 id="-">本文更新说明</h3><ul>
<li>2017.02.16：将 Nginx 更新到 <a href="https://nginx.org/en/CHANGES">1.11.10</a>；</li>
<li>2017.02.06：将 OpenSSL 更新到 <a href="https://www.openssl.org/news/secadv/20170126.txt">1.0.2k</a>；</li>
<li>2017.02.06：将 nginx-ct 升级为 <a href="https://github.com/grahamedgecombe/nginx-ct/blob/master/CHANGELOG.markdown">1.3.2</a>；</li>
<li>2016.12.10：增加「日志自动切分」小节；</li>
<li>2016.10.29：将 Cloudflare 的 ChaCha20/Poly1305 和 <a href="https://blog.cloudflare.com/optimizing-tls-over-tcp-to-reduce-latency/">Dynamic TLS Records</a>（<a href="http://zcfy.cc/article/optimizing-tls-over-tcp-to-reduce-latency-501.html">中文翻译</a>）补丁更新到最新版；</li>
<li>2016.10.29：去掉了「选择二：HTTP/2 + SPDY」和 OpenSSL 1.1.0 相关内容；</li>
<li>2016.10.14：将「选择一：最新版 Nginx」中的 Nginx 更新到 <a href="https://nginx.org/en/CHANGES">1.11.5</a>；</li>
<li>2016.09.27：将 OpenSSL 更新到 1.0.2j 和 1.1.0b，<a href="https://www.openssl.org/news/secadv/20160926.txt">Security Advisory</a>；</li>
<li>2016.09.15：将「选择一：最新版 Nginx」中的 Nginx 更新到 <a href="https://nginx.org/en/CHANGES">1.11.4</a>；</li>
<li>2016.08.27：增加使用 <a href="https://www.openssl.org/news/cl110.txt">OpenSSL 1.1.0</a> 的相关内容； </li>
<li>2016.08.26：增加使用 <a href="https://github.com/google/brotli">Brotli</a> 压缩格式的相关内容； </li>
<li>2016.08.20：将 nginx-ct 升级为支持多证书配置的 1.3.0。配置格式说明<a href="https://github.com/grahamedgecombe/nginx-ct#configuration">见这里</a>；</li>
<li>2016.08.06：将「选择一：最新版 Nginx」中的 Nginx 更新到 <a href="https://nginx.org/en/CHANGES">1.11.3</a>；</li>
<li>2016.07.06：将「选择一：最新版 Nginx」中的 Nginx 更新到 <a href="https://nginx.org/en/CHANGES">1.11.2</a>；</li>
<li>2016.06.13：在「选择二：HTTP/2 + SPDY」中，加上了 Cloudflare 的 <a href="https://blog.cloudflare.com/optimizing-tls-over-tcp-to-reduce-latency/">Dynamic TLS Records</a>（<a href="http://zcfy.cc/article/optimizing-tls-over-tcp-to-reduce-latency-501.html">中文翻译</a>）补丁；</li>
<li>2016.06.01：将「选择一：最新版 Nginx」中的 Nginx 更新到 <a href="https://nginx.org/en/CHANGES">1.11.1</a>；</li>
<li>2016.05.23：为了解决 <code>CVE-2016-2107</code> 安全风险（<a href="https://blog.cloudflare.com/yet-another-padding-oracle-in-openssl-cbc-ciphersuites/">详细介绍</a>、<a href="https://www.openssl.org/news/secadv/20160503.txt">官方说明</a>、<a href="https://filippo.io/CVE-2016-2107/">测试地址</a>），将 OpenSSL 升级到 1.0.2h；&lt;br /&gt;</li>
<li>2016.05.21：补充了「使用 Cloudflare 提供的、让 Nginx 同时支持 HTTP/2 + SPDY 的补丁」有关内容；&lt;br /&gt;</li>
</ul>
<h3 id="-">安装依赖</h3><p>我的 VPS 系统是 Ubuntu 16.04.1 LTS，如果你使用的是其它发行版，与包管理有关的命令请自行调整。</p>
<p>首先安装依赖库和编译要用到的工具：</p>
<div class="ui message"><pre><code class="lang-">sudo apt-<span class="hljs-built_in">get</span> install build-essential libpcre3 libpcre3-<span class="hljs-built_in">dev</span> zlib1g-<span class="hljs-built_in">dev</span> unzip git
</code></pre></div><h3 id="-">获取必要组件</h3><h4 id="nginx-ct">nginx-ct</h4><p><code>nginx-ct</code> 模块用于启用 <a href="https://imququ.com/post/certificate-transparency.html">Certificate Transparency</a> 功能。直接从 github 上获取源码：</p>
<div class="ui message"><pre><code class="lang-">wget -O nginx-<span class="hljs-keyword">ct</span>.<span class="hljs-keyword">zip</span> -c https:<span class="hljs-comment">//github.com/grahamedgecombe/nginx-ct/archive/v1.3.2.zip</span>
unzip nginx-<span class="hljs-keyword">ct</span>.<span class="hljs-keyword">zip</span>
</code></pre></div><h4 id="ngx_brotli">ngx_brotli</h4><p>本站支持 Google 开发的 <a href="https://github.com/google/brotli">Brotli</a> 压缩格式，它通过内置分析大量网页得出的字典，实现了更高的压缩比率，同时几乎不影响压缩 / 解压速度。</p>
<p>以下是让 Nginx 支持 Brotli 所需准备工作，这些工作是一次性的。首先安装 libbrotli：</p>
<div class="ui message"><pre><code class="lang-">sudo apt-<span class="hljs-built_in">get</span> install autoconf libtool automake

git clone http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/bagder/libbrotli
<span class="hljs-keyword">cd</span> libbrotli

# 如果提示 error: C <span class="hljs-keyword">source</span> seen but <span class="hljs-string">'CC'</span> <span class="hljs-keyword">is</span> undefined，可以在 configure.ac 最后加上 AC_PROG_CC
./autogen.<span class="hljs-keyword">sh</span>

./configure
<span class="hljs-keyword">make</span>
sudo <span class="hljs-keyword">make</span> install

<span class="hljs-keyword">cd</span>  ../
</code></pre></div><p>默认 libbrotli 装在 <code>/usr/local/lib/libbrotlienc.so.1</code>，如果后续启动 Nginx 时提示找不到这个文件，那么可以把它软链到 <code>/lib</code> 或者 <code>/usr/lib</code> 目录。如果还有问题，请<a href="https://wangqiliang.com/qi-yong-brotli-ya-suo-suan-fa-ti-gao-xing-neng/">参考这篇文章</a>查找解决方案。</p>
<p>接下来获取 <a href="https://github.com/google/ngx_brotli">ngx_brotli</a> 源码：</p>
<div class="ui message"><pre><code class="lang-">git clone http<span class="hljs-variable">s:</span>//github.<span class="hljs-keyword">com</span>/google/ngx_brotli.git
<span class="hljs-keyword">cd</span> ngx_brotli

git submodule <span class="hljs-keyword">update</span> --init

<span class="hljs-keyword">cd</span> ../
</code></pre></div><h4 id="cloudflare-">Cloudflare 补丁</h4><p>本站主要使用了 Cloudflare 的 ChaCha20/Poly1305 for OpenSSL 补丁，以及 Dynamic TLS Records for Nginx 补丁。先来获取补丁文件：</p>
<div class="ui message"><pre><code class="lang-">git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/cloudflare/sslconfig.git
</code></pre></div><h4 id="openssl">OpenSSL</h4><p>由于系统自带的 OpenSSL 库往往不够新，推荐在编译 Nginx 时指定 OpenSSL 源码目录，而不是使用系统自带的版本，这样更可控。</p>
<p>本站目前使用 OpenSSL 1.0.2k：</p>
<div class="ui message"><pre><code class="lang-">wget -O openssl<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> -c https:<span class="hljs-comment">//github.com/openssl/openssl/archive/OpenSSL_1_0_2k.tar.gz</span>
tar zxf openssl<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span>
mv openssl-OpenSSL_1_0_2k/ openssl
</code></pre></div><p>打上 ChaCha20/Poly1305 补丁：</p>
<div class="ui message"><pre><code class="lang-"><span class="hljs-built_in">cd</span> openssl
patch -p1 &lt; ../sslconfig/patches/openssl__chacha20_poly1305_draft_and_rfc_ossl102j.patch 

<span class="hljs-built_in">cd</span> ../
</code></pre></div><h3 id="-nginx">编译并安装 Nginx</h3><p>接着就可以获取 Nginx 源码，并打上 Dynamic TLS Records 补丁：</p>
<div class="ui message"><pre><code class="lang-">wget -c https:<span class="hljs-comment">//nginx.org/download/nginx-1.11.10.tar.gz</span>
tar zxf nginx-<span class="hljs-number">1.11</span>.<span class="hljs-number">10</span><span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span>

cd nginx-<span class="hljs-number">1.11</span>.<span class="hljs-number">10</span>/
patch -p1 &lt; ../sslconfig/patches/nginx__1.<span class="hljs-number">11.5</span>_dynamic_tls_records<span class="hljs-selector-class">.patch</span>

cd ../
</code></pre></div><p>编译和安装：</p>
<div class="ui message"><pre><code class="lang-">cd nginx<span class="hljs-number">-1.11</span><span class="hljs-number">.10</span>/
./configure --add-<span class="hljs-keyword">module</span>=../ngx_brotli --add-<span class="hljs-keyword">module</span>=../nginx-ct<span class="hljs-number">-1.3</span><span class="hljs-number">.2</span> --<span class="hljs-keyword">with</span>-openssl=../openssl --<span class="hljs-keyword">with</span>-http_v2_module --<span class="hljs-keyword">with</span>-http_ssl_module --<span class="hljs-keyword">with</span>-http_gzip_static_module

make
sudo make install
</code></pre></div><p>除了 <code>http_v2</code> 和 <code>http_ssl</code> 这两个 HTTP/2 必备模块之外，我还额外启用了 <code>http_gzip_static</code>，需要启用哪些模块需要根据自己实际情况来决定（注：从 Nginx 1.11.5 开始，<code>ipv6</code> 模块已经内置，故 <code>--with-ipv6</code> 配置项已被移除）。</p>
<p>以上步骤会把 Nginx 装到 <code>/usr/local/nginx/</code> 目录，如需更改路径可以在 configure 时指定。</p>
<h3 id="-">管理脚本与自启动</h3><p>为了方便管理 Nginx 服务，再创建一个管理脚本：</p>
<div class="ui message"><pre><code class="lang-">sudo vim <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/nginx</span>
</code></pre></div><p>输入以下内容：</p>
<div class="ui message"><pre><code class="lang-"><span class="hljs-meta">#! /bin/sh
</span>
<span class="hljs-comment">### BEGIN INIT INFO</span>
<span class="hljs-comment"># Provides:          nginx</span>
<span class="hljs-comment"># Required-Start:    $all</span>
<span class="hljs-comment"># Required-Stop:     $all</span>
<span class="hljs-comment"># Default-Start:     2 3 4 5</span>
<span class="hljs-comment"># Default-Stop:      0 1 6</span>
<span class="hljs-comment"># Short-Description: starts the nginx web server</span>
<span class="hljs-comment"># Description:       starts nginx using start-stop-daemon</span>
<span class="hljs-comment">### END INIT INFO</span>

PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx
NAME=nginx
DESC=nginx

<span class="hljs-built_in">test</span> -x <span class="hljs-variable">$DAEMON</span> || <span class="hljs-built_in">exit</span> 0

<span class="hljs-comment"># Include nginx defaults if available</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-_">-f</span> /etc/default/nginx ] ; <span class="hljs-keyword">then</span>
  . /etc/default/nginx
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">set</span> <span class="hljs-_">-e</span>

. /lib/lsb/init-functions

<span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
  start)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Starting <span class="hljs-variable">$DESC</span>: "</span>
    start-stop-daemon --start --quiet --pidfile /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid \
        --exec <span class="hljs-variable">$DAEMON</span> -- <span class="hljs-variable">$DAEMON_OPTS</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$NAME</span>."</span>
    ;;
  stop)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Stopping <span class="hljs-variable">$DESC</span>: "</span>
    start-stop-daemon --stop --quiet --pidfile /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid \
        --exec <span class="hljs-variable">$DAEMON</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$NAME</span>."</span>
    ;;
  restart|force-reload)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Restarting <span class="hljs-variable">$DESC</span>: "</span>
    start-stop-daemon --stop --quiet --pidfile \
        /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid --exec <span class="hljs-variable">$DAEMON</span> || <span class="hljs-literal">true</span>
    sleep 1
    start-stop-daemon --start --quiet --pidfile \
        /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid --exec <span class="hljs-variable">$DAEMON</span> -- <span class="hljs-variable">$DAEMON_OPTS</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$NAME</span>."</span>
    ;;
  reload)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Reloading <span class="hljs-variable">$DESC</span> configuration: "</span>
    start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid \
        --exec <span class="hljs-variable">$DAEMON</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$NAME</span>."</span>
    ;;
  status)
    status_of_proc -p /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid <span class="hljs-string">"<span class="hljs-variable">$DAEMON</span>"</span> nginx &amp;&amp; <span class="hljs-built_in">exit</span> 0 || <span class="hljs-built_in">exit</span> $?
    ;;
  *)
    N=/etc/init.d/<span class="hljs-variable">$NAME</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$N</span> {start|stop|restart|reload|force-reload|status}"</span> &gt;&amp;2
    <span class="hljs-built_in">exit</span> 1
    ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-built_in">exit</span> 0
</code></pre></div><p>增加执行权限：</p>
<div class="ui message"><pre><code class="lang-">sudo chmod a+x <span class="hljs-regexp">/etc/i</span>nit.d<span class="hljs-regexp">/nginx</span>
</code></pre></div><p>现在管理 Nginx 只需使用以下命令即可：</p>
<div class="ui message"><pre><code class="lang-">sudo service nginx start|<span class="hljs-type">stop</span>|<span class="hljs-type">restart</span>|<span class="hljs-type">reload</span>
</code></pre></div><p>如果要开机自动启动 Nginx，请执行以下命令：</p>
<div class="ui message"><pre><code class="lang-">sudo <span class="hljs-keyword">update</span>-rc.d -f nginx <span class="hljs-keyword">defaults</span>
</code></pre></div><h3 id="nginx-">Nginx 全局配置</h3><p>到此为止，Nginx 已经安装完毕。再来修改一下它的全局配置，打开 <code>/usr/local/nginx/conf/nginx.conf</code>，新增或修改以下内容：</p>
<div class="ui message"><pre><code class="lang-">http {
    include            mime.types;
    default_type       <span class="hljs-built_in">application</span>/octet-stream;

    charset            UTF<span class="hljs-number">-8</span>;

    sendfile           <span class="hljs-keyword">on</span>;
    tcp_nopush         <span class="hljs-keyword">on</span>;
    tcp_nodelay        <span class="hljs-keyword">on</span>;

    keepalive_timeout  <span class="hljs-number">60</span>;

    <span class="hljs-comment">#... ...#</span>

    gzip               <span class="hljs-keyword">on</span>;
    gzip_vary          <span class="hljs-keyword">on</span>;

    gzip_comp_level    <span class="hljs-number">6</span>;
    gzip_buffers       <span class="hljs-number">16</span> <span class="hljs-number">8</span>k;

    gzip_min_length    <span class="hljs-number">1000</span>;
    gzip_proxied       any;
    gzip_disable       <span class="hljs-string">"msie6"</span>;

    gzip_http_version  <span class="hljs-number">1.0</span>;

    gzip_types         <span class="hljs-built_in">text</span>/plain <span class="hljs-built_in">text</span>/css <span class="hljs-built_in">application</span>/json <span class="hljs-built_in">application</span>/x-javascript <span class="hljs-built_in">text</span>/xml <span class="hljs-built_in">application</span>/xml <span class="hljs-built_in">application</span>/xml+rss <span class="hljs-built_in">text</span>/javascript <span class="hljs-built_in">application</span>/javascript image/svg+xml;

    <span class="hljs-comment"># 如果编译时添加了 ngx_brotli 模块，需要增加 brotli 相关配置</span>
    brotli             <span class="hljs-keyword">on</span>;
    brotli_comp_level  <span class="hljs-number">6</span>;
    brotli_types       <span class="hljs-built_in">text</span>/plain <span class="hljs-built_in">text</span>/css <span class="hljs-built_in">application</span>/json <span class="hljs-built_in">application</span>/x-javascript <span class="hljs-built_in">text</span>/xml <span class="hljs-built_in">application</span>/xml <span class="hljs-built_in">application</span>/xml+rss <span class="hljs-built_in">text</span>/javascript <span class="hljs-built_in">application</span>/javascript image/svg+xml;

    <span class="hljs-comment">#... ...#</span>

    include            /home/jerry/www/nginx_conf/*.conf;
}
</code></pre></div><p>最后的 <code>include</code> 用来加载我个人目录下的配置文件，这样今后创建和修改站点配置就不需要再使用 sudo 权限了。</p>
<p>要让网站支持浏览器通过 HTTP/2 访问必须先部署 HTTPS，要部署 HTTPS 必须先有合法的证书。本博客目前在用 RapidSSL 单域名证书，在 <a href="https://www.namecheap.com/security/ssl-certificates/rapidssl/rapidssl.aspx">NameCheap</a> 购买。另外，我还申请了 <a href="http://www.letsencrypt.org/">Let&#39;s Encrypt</a> 的免费证书备用。一般情况下，个人使用 Let&#39;s Encrypt 的免费证书就足够了，还可以节省一笔开销。</p>
<p>要申请 Let&#39;s Encrypt 证书，推荐使用 <a href="https://github.com/Neilpang/acme.sh">Neilpang/acme.sh</a> 这个小巧无依赖的命令行工具，或者参考我的这篇文章：<a href="https://imququ.com/post/letsencrypt-certificate.html">Let&#39;s Encrypt，免费好用的 HTTPS 证书</a>。</p>
<p>注：Let&#39;s Encrypt 已于 2016 年 3 月 26 日修复 Windows XP 下的兼容问题，本站也第一时间切换到 Let&#39;s Encrypt 证书。</p>
<h3 id="web-">WEB 站点配置</h3><p>以下是本博客站点完整配置：</p>
<div class="ui message"><pre><code class="lang-"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span>               <span class="hljs-number">443</span> ssl http2 fastopen=<span class="hljs-number">3</span> reuseport;

    <span class="hljs-comment"># 如果你使用了 Cloudflare 的 HTTP/2 + SPDY 补丁，记得加上 spdy</span>
    <span class="hljs-comment"># listen               443 ssl http2 spdy fastopen=3 reuseport;</span>

    <span class="hljs-attribute">server_name</span>          www.imququ.com imququ.com;
    <span class="hljs-attribute">server_tokens</span>        <span class="hljs-literal">off</span>;

    <span class="hljs-attribute">include</span>              /home/jerry/www/nginx_conf/ip.blacklist;

    <span class="hljs-comment"># https://imququ.com/post/certificate-transparency.html#toc-2</span>
    <span class="hljs-attribute">ssl_ct</span>               <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">ssl_ct_static_scts</span>   /home/jerry/www/scts;

    <span class="hljs-comment"># 中间证书 + 站点证书</span>
    <span class="hljs-attribute">ssl_certificate</span>      /home/jerry/www/ssl/chained.pem;

    <span class="hljs-comment"># 创建 CSR 文件时用的密钥</span>
    <span class="hljs-attribute">ssl_certificate_key</span>  /home/jerry/www/ssl/domain.key;

    <span class="hljs-comment"># openssl dhparam -out dhparams.pem 2048</span>
    <span class="hljs-comment"># https://weakdh.org/sysadmin.html</span>
    <span class="hljs-attribute">ssl_dhparam</span>          /home/jerry/www/ssl/dhparams.pem;

    <span class="hljs-comment"># https://github.com/cloudflare/sslconfig/blob/master/conf</span>
    <span class="hljs-attribute">ssl_ciphers</span>                EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;

    <span class="hljs-comment"># 如果启用了 RSA + ECDSA 双证书，Cipher Suite 可以参考以下配置：</span>
    <span class="hljs-comment"># ssl_ciphers              EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;</span>

    <span class="hljs-attribute">ssl_prefer_server_ciphers</span>  <span class="hljs-literal">on</span>;

    <span class="hljs-attribute">ssl_protocols</span>              TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;

    <span class="hljs-attribute">ssl_session_cache</span>          shared:SSL:<span class="hljs-number">50m</span>;
    <span class="hljs-attribute">ssl_session_timeout</span>        <span class="hljs-number">1d</span>;

    <span class="hljs-attribute">ssl_session_tickets</span>        <span class="hljs-literal">on</span>;

    <span class="hljs-comment"># openssl rand 48 &gt; session_ticket.key</span>
    <span class="hljs-comment"># 单机部署可以不指定 ssl_session_ticket_key</span>
    <span class="hljs-attribute">ssl_session_ticket_key</span>     /home/jerry/www/ssl/session_ticket.key;

    <span class="hljs-attribute">ssl_stapling</span>               <span class="hljs-literal">on</span>;
    <span class="hljs-attribute">ssl_stapling_verify</span>        <span class="hljs-literal">on</span>;

    <span class="hljs-comment"># 根证书 + 中间证书</span>
    <span class="hljs-comment"># https://imququ.com/post/why-can-not-turn-on-ocsp-stapling.html</span>
    <span class="hljs-attribute">ssl_trusted_certificate</span>    /home/jerry/www/ssl/full_chained.pem;

    <span class="hljs-attribute">resolver</span>                   <span class="hljs-number">114.114.114.114</span> valid=<span class="hljs-number">300s</span>;
    <span class="hljs-attribute">resolver_timeout</span>           <span class="hljs-number">10s</span>;

    <span class="hljs-attribute">access_log</span>                 /home/jerry/www/nginx_log/imququ_com.log;

    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_method</span> !<span class="hljs-regexp">~ ^(GET|HEAD|POST|OPTIONS)$</span> ) {
        <span class="hljs-attribute">return</span>           <span class="hljs-number">444</span>;
    }

    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$host</span> != <span class="hljs-string">'imququ.com'</span> ) {
        <span class="hljs-attribute">rewrite</span>         <span class="hljs-regexp"> ^/(.*)$</span>  https://imququ.com/<span class="hljs-variable">$1</span> <span class="hljs-literal">permanent</span>;
    }

    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~* (robots\.txt|favicon\.ico|crossdomain\.xml|google4c90d18e696bdcf8\.html|BingSiteAuth\.xml)$</span> {
        <span class="hljs-attribute">root</span>             /home/jerry/www/imququ.com/www/static;
        <span class="hljs-attribute">expires</span>          <span class="hljs-number">1d</span>;
    }

    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /static/uploads/ {
        <span class="hljs-attribute">root</span>             /home/jerry/www/imququ.com/www;
        <span class="hljs-attribute">add_header</span>       Access-Control-Allow-Origin *;

        <span class="hljs-attribute">set</span>              <span class="hljs-variable">$expires_time</span> max;

        <span class="hljs-attribute">valid_referers</span>   <span class="hljs-literal">blocked</span> <span class="hljs-literal">none</span> server_names <span class="hljs-regexp">*.qgy</span>18.com <span class="hljs-regexp">*.inoreader.com</span> feedly.com <span class="hljs-regexp">*.feedly.com</span> www.udpwork.com theoldreader.com digg.com <span class="hljs-regexp">*.feiworks.com</span> <span class="hljs-regexp">*.newszeit.com</span> r.mail.qq.com yuedu.<span class="hljs-number">163</span>.com <span class="hljs-regexp">*.w</span>3ctech.com;
        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$invalid_referer</span>) {
            <span class="hljs-attribute">set</span>          <span class="hljs-variable">$expires_time</span> -<span class="hljs-number">1</span>;
            <span class="hljs-attribute">return</span>       <span class="hljs-number">403</span>;
        }

        <span class="hljs-attribute">expires</span>          <span class="hljs-variable">$expires_time</span>;
    }

    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /static/ {
        <span class="hljs-attribute">root</span>             /home/jerry/www/imququ.com/www;
        <span class="hljs-attribute">add_header</span>       Access-Control-Allow-Origin *;      
        <span class="hljs-attribute">expires</span>          max;
    }

    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /admin/ {
        <span class="hljs-attribute">proxy_http_version</span>       <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;

        <span class="hljs-attribute">add_header</span>               Strict-Transport-Security <span class="hljs-string">"max-age=31536000; includeSubDomains; preload"</span>;

        <span class="hljs-comment"># DENY 将完全不允许页面被嵌套，可能会导致一些异常。如果遇到这样的问题，建议改成 SAMEORIGIN</span>
        <span class="hljs-comment"># https://imququ.com/post/web-security-and-response-header.html#toc-1</span>
        <span class="hljs-attribute">add_header</span>               X-Frame-Options DENY;

        <span class="hljs-attribute">add_header</span>               X-Content-Type-Options nosniff;

        <span class="hljs-attribute">proxy_set_header</span>         X-Via            QingDao.Aliyun;
        <span class="hljs-attribute">proxy_set_header</span>         Connection       <span class="hljs-string">""</span>;
        <span class="hljs-attribute">proxy_set_header</span>         Host             imququ.com;
        <span class="hljs-attribute">proxy_set_header</span>         X-Real_IP        <span class="hljs-variable">$remote_addr</span>;
        <span class="hljs-attribute">proxy_set_header</span>         X-Forwarded-For  <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;

        <span class="hljs-attribute">proxy_pass</span>               http://127.0.0.1:9095;
    }

    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">proxy_http_version</span>       <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;

        <span class="hljs-attribute">add_header</span>               Strict-Transport-Security <span class="hljs-string">"max-age=31536000; includeSubDomains; preload"</span>;
        <span class="hljs-attribute">add_header</span>               X-Frame-Options deny;
        <span class="hljs-attribute">add_header</span>               X-Content-Type-Options nosniff;
        <span class="hljs-attribute">add_header</span>               Content-Security-Policy <span class="hljs-string">"default-src 'none'; script-src 'unsafe-inline' 'unsafe-eval' blob: https:; img-src data: https: http://ip.qgy18.com; style-src 'unsafe-inline' https:; child-src https:; connect-src 'self' https://translate.googleapis.com; frame-src https://disqus.com https://www.slideshare.net"</span>;
        <span class="hljs-attribute">add_header</span>               Public-Key-Pins <span class="hljs-string">'pin-sha256="YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg="; pin-sha256="aef6IF2UF6jNEwA2pNmP7kpgT6NFSdt7Tqf5HzaIGWI="; max-age=2592000; includeSubDomains'</span>;
        <span class="hljs-attribute">add_header</span>               Cache-Control <span class="hljs-literal">no</span>-cache;

        <span class="hljs-attribute">proxy_ignore_headers</span>     Set-Cookie;

        <span class="hljs-attribute">proxy_hide_header</span>        Vary;
        <span class="hljs-attribute">proxy_hide_header</span>        X-Powered-By;

        <span class="hljs-attribute">proxy_set_header</span>         X-Via            QingDao.Aliyun;
        <span class="hljs-attribute">proxy_set_header</span>         Connection       <span class="hljs-string">""</span>;
        <span class="hljs-attribute">proxy_set_header</span>         Host             imququ.com;
        <span class="hljs-attribute">proxy_set_header</span>         X-Real_IP        <span class="hljs-variable">$remote_addr</span>;
        <span class="hljs-attribute">proxy_set_header</span>         X-Forwarded-For  <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;

        <span class="hljs-attribute">proxy_pass</span>               http://127.0.0.1:9095;
    }
}

<span class="hljs-section">server</span> {
    <span class="hljs-attribute">server_name</span>       www.imququ.com imququ.com;
    <span class="hljs-attribute">server_tokens</span>     <span class="hljs-literal">off</span>;

    <span class="hljs-attribute">access_log</span>        /dev/null;

    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_method</span> !<span class="hljs-regexp">~ ^(GET|HEAD|POST)$</span> ) {
        <span class="hljs-attribute">return</span>        <span class="hljs-number">444</span>;
    }

    <span class="hljs-attribute">location</span><span class="hljs-regexp"> ^~</span> /.well-known/acme-challenge/ {
        <span class="hljs-attribute">alias</span>         /home/jerry/www/challenges/;
        <span class="hljs-attribute">try_files</span>     <span class="hljs-variable">$uri</span> =<span class="hljs-number">404</span>;
    }

    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">rewrite</span>      <span class="hljs-regexp"> ^/(.*)$</span> https://imququ.com/<span class="hljs-variable">$1</span> <span class="hljs-literal">permanent</span>;
    }
}
</code></pre></div><p>以上配置中的一些关键点分散在我之前的这些文章中：</p>
<ul>
<li><a href="https://imququ.com/post/my-nginx-conf-for-wpo.html">本博客 Nginx 配置之性能篇</a>；</li>
<li><a href="https://imququ.com/post/my-nginx-conf-for-security.html">本博客 Nginx 配置之安全篇</a>；</li>
<li><a href="https://imququ.com/post/optimize-tls-handshake.html">TLS 握手优化详解</a>；</li>
<li><a href="https://imququ.com/post/sth-about-switch-to-https.html">关于启用 HTTPS 的一些经验分享（一）</a>；</li>
<li><a href="https://imququ.com/post/sth-about-switch-to-https-2.html">关于启用 HTTPS 的一些经验分享（二）</a>；</li>
<li><a href="https://imququ.com/post/certificate-transparency.html">Certificate Transparency 那些事</a>；</li>
<li><a href="https://imququ.com/post/http-public-key-pinning.html">HTTP Public Key Pinning 介绍</a>；</li>
<li><a href="https://imququ.com/post/why-can-not-turn-on-ocsp-stapling.html">从无法开启 OCSP Stapling 说起</a>；</li>
</ul>
<h3 id="-">日志自动切分</h3><p>上一节中，我在 Nginx 的站点配置中通过 <code>access_log</code> 指定了访问日志的存放位置。Nginx 启动后，会持续往这个文件写入访问日志。如果网站访问量很大，最好能按照指定大小或者时间间隔切分日志，便于后期管理和排查问题。</p>
<p>虽然本站访问量不大，但我也使用了 <code>logrotate</code> 工具对访问日志进行了按天切分。 </p>
<p>大多数 Linux 发行版都内置了 <code>logrotate</code>，只需新建一个配置文件即可，例如：</p>
<div class="ui message"><pre><code class="lang-">sudo vim /etc/logrotate.d/nginx

/home/jerry/www/nginx_log/*.log {
    su root root
    daily
    rotate 5
    missingok
    notifempty
    sharedscripts
    dateext
    postrotate
        <span class="hljs-keyword">if</span> [ <span class="hljs-_">-f</span> /usr/<span class="hljs-built_in">local</span>/nginx/logs/nginx.pid ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">kill</span> -USR1 `cat /usr/<span class="hljs-built_in">local</span>/nginx/logs/nginx.pid`
        <span class="hljs-keyword">fi</span>
    endscript
}
</code></pre></div><p>配置中具体指令的含义可以查看<a href="http://www.linuxcommand.org/man_pages/logrotate8.html">手册</a>。配置好之后，可以手动执行一下，看是否正常：</p>
<div class="ui message"><pre><code class="lang-">sudo <span class="hljs-regexp">/usr/</span>sbin<span class="hljs-regexp">/logrotate -f /</span>etc<span class="hljs-regexp">/logrotate.d/</span>nginx
</code></pre></div><p>如果一切无误，后续 Nginx 的访问日志就会自动按天切分，并以年月日做为文件后缀，一目了然。</p>
<p>在我的 Ubuntu 16.04.1 LTS 上，<code>/etc/logrotate.d/</code> 目录中的日志切分任务会由 <code>/etc/cron.daily/logrotate</code> 来确保每天执行一次。查看 <code>/etc/crontab</code> 会发现 <code>cron.daily</code> 任务会在每天 6:25 执行，这就是 logrotate 每天切分日志的时机。</p>
<p>如果想要让日志正好在零点被切分，可以修改 <code>cron.daily</code> 的执行时机，也可以把自己的 logrotate 配置文件放在 <code>/etc/logrotate.d/</code> 之外，再手动配置 crontab 规则。</p>
<h3 id="-">安全测试和评分</h3><p>一切妥当后，推荐使用以下两个在线服务来检测站点 HTTPS 配置：</p>
<p><strong>1）Qualys SSL Labs&#39;s SSL Server Test</strong></p>
<p>测试地址：<a href="https://www.ssllabs.com/ssltest/index.html">https://www.ssllabs.com/ssltest/index.html</a>，以下是本博客测试结果截图：</p>
<p>&lt;img alt=&quot;ssllabs test of imququ.com&quot; src=&quot;https://st.imququ.com/static/uploads/2016/03/ssllabs_test_of_imququ_com.png&quot; width=&quot;798&quot; itemprop=&quot;image&quot; /&gt;&lt;a href=&quot;https://ssllabs.com/ssltest/analyze.html?d=imququ.com&quot;&gt;查看完整测试结果 »&lt;/a&gt;</p>
<p>注：如果选择使用 Cloudflare 的 HTTP/2 + SPDY 修改版，记得在站点配置中加上 <code>spdy</code>，这样才能增加对 SPDY 协议的支持。如果配置正确，在这个工具的 NPN 信息中可以看到类似这样的结果：<code>Yes  h2 spdy/3.1 http/1.1</code>。</p>
<p><strong>2）HTTP Security Report</strong></p>
<p>测试地址：<a href="https://httpsecurityreport.com/">https://httpsecurityreport.com/</a>，以下是本博客测试结果截图：</p>
<p>&lt;img alt=&quot;http security report of imququ.com&quot; src=&quot;https://st.imququ.com/static/uploads/2016/03/http_security_report_of_imququ_com.png&quot; width=&quot;776&quot; itemprop=&quot;image&quot; /&gt;&lt;a href=&quot;https://httpsecurityreport.com/?report=imququ.com&quot;&gt;查看完整测试结果 »&lt;/a&gt;</p>
<p>原文链接：<a href="https://imququ.com/post/my-nginx-conf.html">https://imququ.com/post/my-nginx-conf.html</a>，<a href="https://imququ.com/post/my-nginx-conf.html#comments">前往原文评论 »</a></p>

                <p><a href="../MD/test2.md">查看本文Markdown版本</a></p>
                <div id="disqus_thread"></div>
                <script>
                
                /**
                *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                
                var disqus_config = function () {
                this.page.url = 'https://maicss.com/archives/test2.html';  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = 'test2'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };
                
                (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');
                s.src = '//https-www-maicss-com.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <script id="dsq-count-scr" src="//https-www-maicss-com.disqus.com/count.js" async></script>
            </body>
        </html>